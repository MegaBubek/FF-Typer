<!DOCTYPE html>
<html lang="pl">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FF-Typer Ekstraklasa 25/26</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:20px; }
    .screen { display:none; max-width:600px; background:#fff; margin:auto; margin-top:30px; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .active { display:block; }
    input, select, button { width:100%; padding:10px; margin:8px 0; border-radius:5px; border:1px solid #ccc; }
    button { background:#007bff; color:#fff; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ccc; padding:8px; font-size:14px; text-align:center; }
    th { background:#eee; }
  </style>
</head>
<body>

<!-- REJESTRACJA -->
<div id="registerScreen" class="screen active">
  <h2>Rejestracja</h2>
  <input id="regNick" placeholder="Nick" />
  <input id="regEmail" type="email" placeholder="Email" />
  <input id="regPass" type="password" placeholder="Hasło" />
  <button onclick="register()">Zarejestruj się</button>
  <p><a href="#" onclick="showScreen('loginScreen')">Masz konto? Zaloguj się</a></p>
</div>

<!-- LOGOWANIE -->
<div id="loginScreen" class="screen">
  <h2>Logowanie</h2>
  <input id="logEmail" type="email" placeholder="Email" />
  <input id="logPass" type="password" placeholder="Hasło" />
  <button onclick="login()">Zaloguj się</button>
  <p><a href="#" onclick="showScreen('registerScreen')">Nie masz konta? Zarejestruj się</a></p>
</div>

<!-- STRONA GŁÓWNA -->
<div id="mainScreen" class="screen">
  <h2>Witaj, <span id="userNick"></span>!</h2>
  <label>
    Wybierz kolejkę:
    <select id="roundSelect"></select>
  </label>
  <div id="matches"></div>
  <button onclick="savePredictions()">Zapisz typy</button>
  <div id="adminPanel">
    <h3>Obstawione meczów (tylko Ty - admin)</h3>
    <div id="allPredictions">Wczytywanie...</div>
  </div>
  <button onclick="logout()">Wyloguj się</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

// ✅ Wklej swój firebaseConfig stąd:
const firebaseConfig = {
  apiKey: "AIzaSyDIhMW94ZY7_7w8yttJSHAwmCPR3bSTsHw",
  authDomain: "ff-typer.firebaseapp.com",
  projectId: "ff-typer",
  storageBucket: "ff-typer.appspot.com",
  messagingSenderId: "22978913956",
  appId: "1:22978913956:web:6e6113180e48142d952831"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const schedule = {
  1: ["Jagiellonia Białystok - Bruk-Bet Termalica Nieciecza","Lech Poznań - Cracovia","Widzew Łódź - Zagłębie Lubin"],
  2: ["Arka Gdynia - Radomiak Radom","Lechia Gdańsk - Lech Poznań","Pogoń Szczecin - Motor Lublin"],
  3: ["Wisła Płock - Piast Gliwice","Bruk-Bet Termalica - Pogoń Szczecin","Legia Warszawa - Arka Gdynia"]
};

const nickEl = document.getElementById("userNick");
const roundSelect = document.getElementById("roundSelect");

Object.keys(schedule).forEach(r=>{
  let o=document.createElement("option");
  o.value=r; o.text="Kolejka "+r;
  roundSelect.append(o);
});

function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

async function register(){
  try{
    await createUserWithEmailAndPassword(auth, regEmail.value, regPass.value);
    const user = auth.currentUser;
    await setDoc(doc(db,"users",user.uid),{nick:regNick.value});
  }catch(e){ alert(e.message); }
}

async function login(){
  try{ await signInWithEmailAndPassword(auth, logEmail.value, logPass.value); }
  catch(e){ alert(e.message); }
}

function logout(){
  signOut(auth);
}

function renderMatches(){
  const sel = roundSelect.value;
  const mDiv = document.getElementById("matches");
  mDiv.innerHTML = "";
  schedule[sel].forEach((m,i)=>{
    mDiv.innerHTML+=`
      <div class="match">
        <strong>${m}</strong><br>
        <input placeholder="np. 2:1" id="t${i}"/>
      </div>`;
  });
}

async function savePredictions(){
  const uid = auth.currentUser.uid;
  const rnd = roundSelect.value;
  const data = {round:rnd, timestamp:serverTimestamp()};
  schedule[rnd].forEach((_,i)=>{
    const v = document.getElementById("t"+i).value;
    if(v) data["m"+i]=v;
  });
  await addDoc(collection(db,"predictions"),{uid, ...data});
  alert("Zapisano!");
  loadAdmin();
}

async function loadAdmin(){
  const ap = document.getElementById("allPredictions");
  ap.innerHTML = "";
  const snap = await getDocs(collection(db,"predictions"));
  for(const d of snap.docs){
    const u = await getDoc(doc(db,"users",d.data().uid));
    const nick = u.exists()?u.data().nick:"?";
    const dat = d.data();
    let html = `<p><strong>${nick}</strong> - kolejka ${dat.round}<br>`;
    Object.keys(dat).filter(k=>k.startsWith("m")).forEach(k=> html+=dat[k]+"<br>");
    html+=`<em>${new Date(dat.timestamp.seconds*1000).toLocaleString()}</em></p>`;
    if(localStorage.getItem("nick")==="admin") ap.innerHTML+=html;
  }
}

onAuthStateChanged(auth,user=>{
  if(user){
    showScreen("mainScreen");
    doc(db,"users",user.uid).get().then(u=>nickEl.textContent=u.data().nick);
    renderMatches();
    loadAdmin();
  } else showScreen("registerScreen");
});

roundSelect.onchange=renderMatches;
</script>
</body>
</html>
